name: Build Knowledge Graph

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  # æ‰‹å‹•å®Ÿè¡Œï¼ˆGitHub UI ã‹ã‚‰ï¼‰
  workflow_dispatch:
    inputs:
      topic:
        description: 'Research topic to search for'
        required: true
        default: 'knowledge graph construction'
      max_papers:
        description: 'Maximum number of papers to process'
        required: false
        default: '5'
      review_only:
        description: 'Only select review/survey papers'
        required: false
        type: boolean
        default: true
      combine:
        description: 'Create combined knowledge graph'
        required: false
        type: boolean
        default: true
      threshold:
        description: 'Relevance threshold (0.0-1.0)'
        required: false
        default: '0.7'

  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆæ¯é€±æœˆæ›œæ—¥ 0:00 UTCï¼‰
  schedule:
    - cron: '0 0 * * 1'  # æ¯é€±æœˆæ›œæ—¥

  # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'config/topics.txt'  # topics.txtãŒæ›´æ–°ã•ã‚ŒãŸã¨ã

# ä¸¦è¡Œå®Ÿè¡Œã®åˆ¶å¾¡
concurrency:
  group: build-kg-${{ github.ref }}
  cancel-in-progress: false  # å®Ÿè¡Œä¸­ã®ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãªã„

jobs:
  build-knowledge-graph:
    name: Build Knowledge Graph from Research Papers
    runs-on: ubuntu-latest

    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ2æ™‚é–“ï¼‰
    timeout-minutes: 120

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      # 2. Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv pip install --system -e .

      # 4. ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
      - name: Create data directories
        run: |
          mkdir -p data/papers
          mkdir -p data/exports
          mkdir -p logs

      # 5. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
      - name: Configure environment
        run: |
          cat > .env << EOF
          # LLM Provider
          LLM_PROVIDER=gemini
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL=gemini-2.0-flash-exp

          # Neo4j (not needed for pipeline, but required by settings)
          NEO4J_PASSWORD=dummy_password_for_github_actions
          NEO4J_URI=bolt://localhost:7687

          # Processing
          DEFAULT_TEMPERATURE=0.0
          MAX_TOKENS=4000
          LOG_LEVEL=INFO
          EOF

      # 6. ãƒˆãƒ”ãƒƒã‚¯ã®æ±ºå®šï¼ˆscheduleå®Ÿè¡Œæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ï¼‰
      - name: Determine topic
        id: topic
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "topic=${{ github.event.inputs.topic }}" >> $GITHUB_OUTPUT
            echo "max_papers=${{ github.event.inputs.max_papers }}" >> $GITHUB_OUTPUT
            echo "review_only=${{ github.event.inputs.review_only }}" >> $GITHUB_OUTPUT
            echo "combine=${{ github.event.inputs.combine }}" >> $GITHUB_OUTPUT
            echo "threshold=${{ github.event.inputs.threshold }}" >> $GITHUB_OUTPUT
          else
            # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            echo "topic=knowledge graph construction" >> $GITHUB_OUTPUT
            echo "max_papers=5" >> $GITHUB_OUTPUT
            echo "review_only=true" >> $GITHUB_OUTPUT
            echo "combine=true" >> $GITHUB_OUTPUT
            echo "threshold=0.7" >> $GITHUB_OUTPUT
          fi

      # 7. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè¡Œ
      - name: Run knowledge graph pipeline
        id: pipeline
        run: |
          # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨­å®š
          ARGS="--max-papers ${{ steps.topic.outputs.max_papers }}"
          ARGS="$ARGS --threshold ${{ steps.topic.outputs.threshold }}"

          if [ "${{ steps.topic.outputs.review_only }}" = "true" ]; then
            ARGS="$ARGS --review-papers-only"
          fi

          if [ "${{ steps.topic.outputs.combine }}" = "true" ]; then
            ARGS="$ARGS --combine"
          fi

          # ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
          python scripts/build_knowledge_graph.py "${{ steps.topic.outputs.topic }}" $ARGS
        continue-on-error: false

      # 8. å®Ÿè¡Œã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
      - name: Generate summary
        if: always()
        run: |
          echo "## Knowledge Graph Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Topic:** ${{ steps.topic.outputs.topic }}" >> $GITHUB_STEP_SUMMARY
          echo "**Max Papers:** ${{ steps.topic.outputs.max_papers }}" >> $GITHUB_STEP_SUMMARY
          echo "**Review Only:** ${{ steps.topic.outputs.review_only }}" >> $GITHUB_STEP_SUMMARY
          echo "**Combined Graph:** ${{ steps.topic.outputs.combine }}" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold:** ${{ steps.topic.outputs.threshold }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ
          EXPORT_COUNT=$(ls -1 data/exports/*.json 2>/dev/null | wc -l)
          echo "**Generated Files:** $EXPORT_COUNT JSON files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ
          if [ $EXPORT_COUNT -gt 0 ]; then
            echo "### Generated Knowledge Graphs:" >> $GITHUB_STEP_SUMMARY
            ls -lh data/exports/*.json | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          fi

      # 9. æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆJSONãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
      - name: Upload knowledge graphs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: knowledge-graphs-${{ github.run_number }}
          path: |
            data/exports/*.json
            data/papers/papers_index.json
          retention-days: 90  # 90æ—¥é–“ä¿æŒ

      # 10. æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ­ã‚°ï¼‰
      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pipeline-logs-${{ github.run_number }}
          path: |
            logs/*.log
          retention-days: 30

      # 11. GitHubã¸ã®ã‚³ãƒŸãƒƒãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: Commit and push results
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # JSON ãƒ•ã‚¡ã‚¤ãƒ«ã¨ papers_index.json ã®ã¿è¿½åŠ ï¼ˆPDF ã¯é™¤å¤–ï¼‰
          git add data/exports/*.json
          git add data/papers/papers_index.json

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Auto-build: Add knowledge graphs for '${{ steps.topic.outputs.topic }}' (#${{ github.run_number }})"
            git push
          fi

      # 12. Slackã¸ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      # - name: Notify Slack
      #   if: always()
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     payload: |
      #       {
      #         "text": "Knowledge Graph Build ${{ job.status }}",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "*Knowledge Graph Build ${{ job.status }}*\n*Topic:* ${{ steps.topic.outputs.topic }}\n*Papers:* ${{ steps.topic.outputs.max_papers }}\n*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>"
      #             }
      #           }
      #         ]
      #       }
